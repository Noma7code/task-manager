<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Todo App</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f0f0f0;
        margin: 0;
      }
      h1 {
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: auto;
      }
      .task-form,
      .filter {
        margin-bottom: 20px;
      }
      .task {
        padding: 10px;
        margin: 5px 0;
        background: #fff;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }
      .task input {
        width: 200px;
      }
      button {
        margin-left: 5px;
      }
      .completed {
        text-decoration: line-through;
        color: gray;
      }
      .deleted {
        color: red;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Hello <%= name %></h1>

      <!-- Filter by state -->
      <div class="filter">
        <label for="filterState">Filter by state:</label>
        <select id="filterState">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
          <option value="deleted">Deleted</option>
        </select>
      </div>

      <!-- Create new task -->
      <div class="task-form">
        <form id="createTaskForm">
          <input
            type="text"
            id="taskName"
            placeholder="Enter new task"
            required
          />
          <button type="submit">Add Task</button>
        </form>
      </div>

      <!-- Task list -->
      <div id="taskList">
        <% tasks.forEach(task => { %>
        <div
          class="task"
          data-id="<%= task._id %>"
          data-state="<%= task.state %>"
        >
          <span
            class="<%= task.state === 'completed' ? 'completed' : task.state === 'deleted' ? 'deleted' : '' %>"
            contenteditable="false"
            ><%= task.task_name %> - <%= task.state %></span
          >
          <div>
            <% if (task.state !== 'deleted') { %>
            <button class="toggleBtn">
              <%= task.state === 'completed' ? 'Mark Pending' : 'Mark Completed'
              %>
            </button>
            <button class="editBtn">Edit</button>
            <button class="saveBtn" style="display: none">Save</button>
            <button class="softDeleteBtn">Move to Trash</button>
            <% } else { %>
            <button class="restoreBtn">Restore</button>
            <button class="hardDeleteBtn">Delete Permanently</button>
            <% } %>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <script>
      const createForm = document.getElementById("createTaskForm");
      const taskList = document.getElementById("taskList");
      const filterState = document.getElementById("filterState");

      // Create task
      createForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const taskName = document.getElementById("taskName").value;
        if (!taskName) return;

        const res = await fetch("/api/tasks/create-task", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ task_name: taskName }),
          credentials: "include",
        });

        const data = await res.json();
        if (data.success) location.reload();
        else alert(data.message);
      });

      // Task list buttons
      taskList.addEventListener("click", async (e) => {
        const taskDiv = e.target.closest(".task");
        if (!taskDiv) return;
        const taskId = taskDiv.dataset.id;
        const span = taskDiv.querySelector("span");

        // Toggle Completed/Pending
        if (e.target.classList.contains("toggleBtn")) {
          const newState =
            taskDiv.dataset.state === "completed" ? "pending" : "completed";

          const res = await fetch(`/api/tasks/update-task/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ state: newState }),
            credentials: "include",
          });
          const data = await res.json();
          if (data.success) location.reload();
          else alert(data.message);
        }

        // Soft delete
        if (e.target.classList.contains("softDeleteBtn")) {
          const res = await fetch(
            `/api/tasks/update-task-to-delete/${taskId}`,
            {
              method: "PUT",
              credentials: "include",
            }
          );
          const data = await res.json();
          if (data.success) location.reload();
          else alert(data.message);
        }

        // Hard delete
        if (e.target.classList.contains("hardDeleteBtn")) {
          if (!confirm("This will permanently delete the task. Continue?"))
            return;

          const res = await fetch(`/api/tasks/delete-task/${taskId}`, {
            method: "DELETE",
            credentials: "include",
          });
          const data = await res.json();
          if (data.success) location.reload();
          else alert(data.message);
        }

        // Restore
        if (e.target.classList.contains("restoreBtn")) {
          const res = await fetch(`/api/tasks/update-task/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ state: "pending" }),
            credentials: "include",
          });
          const data = await res.json();
          if (data.success) location.reload();
          else alert(data.message);
        }

        // Edit task name
        if (e.target.classList.contains("editBtn")) {
          span.contentEditable = true;
          span.focus();
          e.target.style.display = "none";
          taskDiv.querySelector(".saveBtn").style.display = "inline";
        }

        // Save updated task
        if (e.target.classList.contains("saveBtn")) {
          const updatedName = span.textContent.split(" - ")[0];
          const res = await fetch(`/api/tasks/update-task/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task_name: updatedName }),
            credentials: "include",
          });
          const data = await res.json();
          if (data.success) {
            span.contentEditable = false;
            e.target.style.display = "none";
            taskDiv.querySelector(".editBtn").style.display = "inline";
            location.reload();
          } else {
            alert(data.message);
          }
        }
      });

      // Filter tasks by state
      filterState.addEventListener("change", () => {
        const selectedState = filterState.value;
        document.querySelectorAll(".task").forEach((taskDiv) => {
          if (!selectedState || taskDiv.dataset.state === selectedState) {
            taskDiv.style.display = "flex";
          } else {
            taskDiv.style.display = "none";
          }
        });
      });
    </script>
  </body>
</html>
